%% CLASSIFICATION USING DECISION TREE
% THIS SCRIPT USE THE TECHNIQUES OF DECISION TREE TO CLASSIFY THE DATA OF
% A MFVEP TEST SIGNAL TO RATIO IN THREE GROUPS OF PEOPLE, THE ONES THAT ARE
% HEALTHY AND THE ONES THAT ARE WITH MULTIPLE SCLEROSIS AND NEUROMYELITIS
% OPTICA. WE USE FEATURE SELECTION TO REDUCE THE RAW DATA 60 FEATURES, USING
% THE CROSS-VALIDATION METHOD AS PARAMETER TO EVALUATE THE FEATURES.

%% ABOUT
% * Author: Iraquitan Cordeiro Filho
% * Mentor: Schubert Carvalho
% * Company: Institudo Tecnologico Vale - Desenvolvimento Sustentavel

%% PRELIMINARIES
% Clear our workspace
clear all
clc

% Close all figures
close all

% This finds handles to all the objects in the current session, filters it
% to find just the handles to the Classification tree viewers so that they
% can be selectively closed.
child_handles = allchild(0);
names = get(child_handles,'Name');
k = find(strncmp('Classification tree viewer', names, 3));
close(child_handles(k))

% * IMPORTING THE DATA
%
load('data');

% * EXPORTING THE DATA
%


%% PRE-PROCESSING THE DATA
%
% Normalize data
[minimaxNorm,zscoreNorm,decimalscalNorm,~,~,~,~,~,~] = data_norm(X,Y);
% Loads the normalized data
%load('dataNormalized_1');
%% DIVIDE THE DATA INTO TRAINING AND TEST SETS
% Here we divide the data for training and testing.
% Divides using kfold = 10

% Divides using holdout with 75% test size.

% Divides using leave one out.

%% GENERATING THE DEFAULT CLASSIFICATION TREE
% Generate the Decision Tree using the training sets.
% Generate the default tree using K-Fold partitions

%% DIVIDE DATA IN CLASSES TO PAIRWISE ANALYSIS
% Two diseases classes
X_minus_saudavel = X(~cellfun(@(x)strcmp(x,'saudavel'),Y),:);
Y_minus_saudavel = Y(~cellfun(@(x)strcmp(x,'saudavel'),Y));

% Healthy and sclerosis classes
X_minus_neuromielite = X(~cellfun(@(x)strcmp(x,'neuromielite otica'),Y),:);
Y_minus_neuromielite = Y(~cellfun(@(x)strcmp(x,'neuromielite otica'),Y));

% Healthy and neuromielite classes
X_minus_esclerose = X(~cellfun(@(x)strcmp(x,'esclerose multipla'),Y),:);
Y_minus_esclerose = Y(~cellfun(@(x)strcmp(x,'esclerose multipla'),Y));

% Healthy and 2 diseases without distinction
Y_saudavel_doente = Y;
for i=1:length(Y)
    if strcmp(Y{i},'neuromielite otica') || strcmp(Y{i},'esclerose multipla')
        Y_saudavel_doente{i} = 'doente';
    end
end
%{
%% PERFORM CROSS_VALIDATION FEATURE SELECTION WITH 2B2 CLASSES
% Tree with the two diseases classes
tree_minus_saudavel = ClassificationTree.fit(X_minus_saudavel,...
    Y_minus_saudavel,'PredictorNames',features_label);
extracted_feats_minus_saudavel = ...
    cv_feat_selection(tree_minus_saudavel, ...
    'kfold',' for two diseases classes');
draw_Dartboard(extracted_feats_minus_saudavel,' for two diseases classes');

% Tree with the healthy and sclerosis classes
tree_minus_neuromielite = ClassificationTree.fit(X_minus_neuromielite,...
    Y_minus_neuromielite,'PredictorNames',features_label);
extracted_feats_minus_neuromielite = ...
    cv_feat_selection(tree_minus_neuromielite, ...
    'kfold',' for healthy and sclerosis classes');
draw_Dartboard(extracted_feats_minus_neuromielite,' for healthy and sclerosis classes');

% Tree with the healthy and neuromielite classes
tree_minus_esclerose = ClassificationTree.fit(X_minus_esclerose,...
    Y_minus_esclerose,'PredictorNames',features_label);
extracted_feats_minus_esclerose = ...
    cv_feat_selection(tree_minus_esclerose, ...
    'kfold',' for healthy and neuromielite classes');
draw_Dartboard(extracted_feats_minus_esclerose,' for healthy and neuromielite classes');
%}
%{
%% PERFORM FORWARD SEQUENTIAL FEATURE SELECTION WITH 2B2 CLASSES
% Two diseases classes
fs_selected_feats_minus_saudavel = forwardFeatSel(X_minus_saudavel,Y_minus_saudavel,' for two diseases classes with forward feature selection');
draw_Dartboard(fs_selected_feats_minus_saudavel,' for two diseases classes with forward feature selection');
% Healthy and sclerosis classes
fs_selected_feats_minus_neuromielite = forwardFeatSel(X_minus_neuromielite,Y_minus_neuromielite,' for healthy and sclerosis classes with forward feature selection');
draw_Dartboard(fs_selected_feats_minus_neuromielite,' for healthy and sclerosis classes with forward feature selection');
% Healthy and neuromielite classes
fs_selected_feats_minus_esclerose = forwardFeatSel(X_minus_esclerose,Y_minus_esclerose,' for healthy and neuromielite classes with forward feature selection');
draw_Dartboard(fs_selected_feats_minus_esclerose,' for healthy and neuromielite classes with forward feature selection');
% Healthy and 2 diseases without distinction
fs_selected_feats_saudavel_doente = forwardFeatSel(X,Y_saudavel_doente,' for healthy and 2 diseases classes with forward feature selection');
draw_Dartboard(fs_selected_feats_saudavel_doente,' for healthy and 2 diseases classes with forward feature selection');
%% PERFORM T-TEST BASED FEATURE SELECTION WITH 2B2 CLASSES
% Two diseases classes
[fs01_minus_saudavel,fs05_minus_saudavel] = filterFeatSel(X_minus_saudavel,Y_minus_saudavel);
draw_Dartboard(fs01_minus_saudavel,' for two diseases classes with filter and p=.01');
draw_Dartboard(fs05_minus_saudavel,' for two diseases classes with filter and p=.05');
% Healthy and sclerosis classes
[fs01_minus_neuromielite,fs05_minus_neuromielite] = filterFeatSel(X_minus_neuromielite,Y_minus_neuromielite);
draw_Dartboard(fs01_minus_neuromielite,' for healthy and sclerosis classes with filter and p=.01');
draw_Dartboard(fs05_minus_neuromielite,' for healthy and sclerosis classes with filter and p=.05');
% Healthy and neuromielite classes
[fs01_minus_esclerose,fs05_minus_esclerose] = filterFeatSel(X_minus_esclerose,Y_minus_esclerose);
draw_Dartboard(fs01_minus_esclerose,' for healthy and neuromielite classes with filter and p=.01');
draw_Dartboard(fs05_minus_esclerose,' for healthy and neuromielite classes with filter and p=.05');
% Healthy and 2 diseases without distinction
[fs01_saudavel_doente,fs05_saudavel_doente] = filterFeatSel(X,Y_saudavel_doente);
draw_Dartboard(fs01_saudavel_doente,' for healthy and 2 diseases classes with filter and p=.01');
draw_Dartboard(fs05_saudavel_doente,' for healthy and 2 diseases classes with filter and p=.05');
%}
%% PERFORM FORWARD SEQUENTIAL FEATURE SELECTION WITH 2B2 CLASSES and p=.05 and p=.01
% Two diseases classes
[fs01_minus_saudavel,fs05_minus_saudavel] = forwardFeatSelNew(X_minus_saudavel,Y_minus_saudavel,' for two diseases classes with sfs and filter');
draw_Dartboard(fs01_minus_saudavel,' for two diseases classes with sfs and filter p=.01');
draw_Dartboard(fs05_minus_saudavel,' for two diseases classes with sfs and filter p=.05');
% Healthy and sclerosis classes
[fs01_minus_neuromielite,fs05_minus_neuromielite] = forwardFeatSelNew(X_minus_neuromielite,Y_minus_neuromielite,' for healthy and sclerosis classes with sfs and filter');
draw_Dartboard(fs01_minus_neuromielite,' for healthy and sclerosis classes with sfs and filter p=.01');
draw_Dartboard(fs05_minus_neuromielite,' for healthy and sclerosis classes with sfs and filter p=.05');
% Healthy and neuromielite classes
[fs01_minus_esclerose,fs05_minus_esclerose] = forwardFeatSelNew(X_minus_esclerose,Y_minus_esclerose,' for healthy and neuromielite classes with sfs and filter');
draw_Dartboard(fs01_minus_esclerose,' for healthy and neuromielite classes with sfs and filter p=.01');
draw_Dartboard(fs05_minus_esclerose,' for healthy and neuromielite classes with sfs and filter p=.05');
% Healthy and 2 diseases without distinction
[fs01_saudavel_doente,fs05_saudavel_doente] = forwardFeatSelNew(X,Y_saudavel_doente,' for healthy and 2 diseases classes with forward sfs and filter');
draw_Dartboard(fs01_saudavel_doente,' for healthy and 2 diseases classes with sfs and filter p=.01');
draw_Dartboard(fs05_saudavel_doente,' for healthy and 2 diseases classes with sfs and filter p=.05');
%% Saves selected features
% Saves selected features from both cross-validation and forward sequential
% feature selection methods
save('selected_features.mat','extracted_feats',...
    'extracted_feats_minus_esclerose','extracted_feats_minus_neuromielite',...
    'extracted_feats_minus_saudavel','fs_selected_feats_minus_esclerose',...
    'fs_selected_feats_minus_neuromielite','fs_selected_feats_minus_saudavel',...
    'fs_selected_feats_saudavel_doente');

% Filter and SFS p=.01 and p=.05

save('last_selected_features.mat','fs01_minus_esclerose',...
    'fs01_minus_neuromielite','fs01_minus_saudavel',...
    'fs01_saudavel_doente','fs05_minus_esclerose',...
    'fs05_minus_neuromielite','fs05_minus_saudavel',...
    'fs05_saudavel_doente');
%% COMPARES THE SELECTED FEATURES
%{
[results_minus_saudavel,eval_results_minus_saudavel] = compareFeatures(X_minus_saudavel,Y_minus_saudavel,...
    extracted_feats_minus_saudavel,fs_selected_feats_minus_saudavel);
[results_minus_neuromielite,eval_results_minus_neuromielite] = compareFeatures(X_minus_neuromielite,Y_minus_neuromielite,...
    extracted_feats_minus_neuromielite,fs_selected_feats_minus_neuromielite);
[results_minus_esclerose,eval_results_minus_esclerose] = compareFeatures(X_minus_esclerose,Y_minus_esclerose,...
    extracted_feats_minus_esclerose,fs_selected_feats_minus_esclerose);
%}
features_selec = unique(horzcat(fs01_minus_esclerose,fs01_minus_neuromielite,fs01_minus_saudavel,fs01_saudavel_doente));

[results_minus_saudavel,eval_results_minus_saudavel] = compareFeatures(X_minus_saudavel,Y_minus_saudavel,...
    fs05_minus_saudavel,allfeatures);
[results_minus_neuromielite,eval_results_minus_neuromielite] = compareFeatures(X_minus_neuromielite,Y_minus_neuromielite,...
    fs01_minus_neuromielite,allfeatures);
[results_minus_esclerose,eval_results_minus_esclerose] = compareFeatures(X_minus_esclerose,Y_minus_esclerose,...
    fs01_minus_esclerose,allfeatures);
[results_saudavel_doente,eval_results_saudavel_doente] = compareFeatures(X,Y_saudavel_doente,...
    fs01_saudavel_doente,allfeatures);
[results_all,eval_results_all] = compareFeatures(X,Y,...
    features_selec,allfeatures);
%% GENERATING THE CLASSIFICATION TREES
% Generate the Decision Trees for each combination with the selected
% features.
% Two diseases classes
Tree_minus_saudavel = ClassificationTree.fit(X_minus_saudavel,Y_minus_saudavel,...
    'PredictorNames',features_label);
view(Tree_minus_saudavel, 'mode', 'graph');

% Healthy and sclerosis classes
Tree_minus_neuromielite = ClassificationTree.fit(X_minus_neuromielite(:,health_and_sclerosis),...
    Y_minus_neuromielite,'PredictorNames',feats_minus_neuromielite);
view(Tree_minus_neuromielite, 'mode', 'graph');

% Healthy and neuromielite classes
Tree_minus_esclerose = ClassificationTree.fit(X_minus_esclerose(:,health_and_neuromielite),...
    Y_minus_esclerose,'PredictorNames',feats_minus_esclerose);
view(Tree_minus_esclerose, 'mode', 'graph');

% Healthy and 2 diseases as one class
Tree_saudavel_doente = ClassificationTree.fit(X(:,health_two_diseases),...
    Y_saudavel_doente,'PredictorNames',feats_saudavel_doente);
view(Tree_saudavel_doente, 'mode', 'graph');

% All classes
Tree_all_classes = ClassificationTree.fit(X(:,features_selec),...
    Y,'PredictorNames',features_selec_label);
view(Tree_all_classes, 'mode', 'graph');